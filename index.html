<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çé¦™å°é¤¨ - ç·šä¸Šè¨‚é¤</title>
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Firebase SDKs for Auth and Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('Debug'); // å–æ¶ˆè¨»é‡‹æ­¤è¡Œå¯æŸ¥çœ‹ Firebase è©³ç´°æ—¥èªŒ

        // --- ğŸš¨ æ­¥é©Ÿä¸€ï¼šè«‹åœ¨é€™è£¡è²¼ä¸Šæ‚¨è‡ªå·±çš„ Firebase è¨­å®š ğŸš¨ ---
        // è«‹å‹™å¿…å¾æ‚¨çš„ Firebase å°ˆæ¡ˆè¨­å®šä¸­å–å¾—ä»¥ä¸‹é‡‘é‘°ã€‚
        const YOUR_FIREBASE_CONFIG = {
            apiKey: null, // <-- è«‹è²¼ä¸Šæ‚¨çš„ apiKey (ä¾‹å¦‚: "AIzaSyC...")
            authDomain: null, // <-- è«‹è²¼ä¸Šæ‚¨çš„ authDomain (ä¾‹å¦‚: "your-project-id.firebaseapp.com")
            projectId: null, // <-- è«‹è²¼ä¸Šæ‚¨çš„ projectId (ä¾‹å¦‚: "your-project-id")
            storageBucket: null,
            messagingSenderId: null,
            appId: null,
            measurementId: null
        };
        // --------------------------------------------------------

        // --- GLOBAL SETUP ---
        window.app = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.isFirebaseReady = false; // è¿½è¹¤ Firebase æ˜¯å¦æˆåŠŸåˆå§‹åŒ–
        window.appId = YOUR_FIREBASE_CONFIG.projectId || 'default-github-page-app'; 

        /**
         * Initializes Firebase services and authenticates the user.
         */
        async function initializeFirebase() {
            const cleanConfig = Object.fromEntries(
                Object.entries(YOUR_FIREBASE_CONFIG).filter(([_, v]) => v !== null)
            );
            const hasUserConfig = cleanConfig.apiKey && cleanConfig.projectId;

            if (!hasUserConfig) {
                console.warn("Firebase è¨­å®šæª”éºå¤±æˆ–æœªå¡«å¯«ã€‚é›²ç«¯è¨‚å–®å‚™ä»½åŠŸèƒ½å·²åœç”¨ (é›¢ç·šæ¨¡å¼)ã€‚");
                document.getElementById('user-info').textContent = 'ç”¨æˆ¶ID: é›¢ç·šæ¨¡å¼ (è«‹å¡«å¯«é…ç½®)';
                return; 
            }
            
            // --- æ­£å¸¸åˆå§‹åŒ–æµç¨‹ (ä½¿ç”¨ç”¨æˆ¶çš„é…ç½®) ---
            try {
                window.app = initializeApp(cleanConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);
                window.isFirebaseReady = true;

                await signInAnonymously(window.auth);

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.currentUserId = user.uid;
                        document.getElementById('user-info').textContent = 'ç”¨æˆ¶ID: ' + user.uid.substring(0, 8) + '... (é›²ç«¯é€£ç·š)';
                    } else {
                        window.currentUserId = null;
                        document.getElementById('user-info').textContent = 'ç”¨æˆ¶ID: é€£ç·šå¤±æ•—';
                    }
                });

            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–éŒ¯èª¤:", error);
                showNotification('Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œé›²ç«¯å‚™ä»½ç„¡æ³•ä½¿ç”¨ã€‚', 'error');
                window.isFirebaseReady = false;
            }
        }

        // Expose Firebase functions to the global scope
        window.initializeFirebase = initializeFirebase;
        window.addDoc = addDoc;
        window.collection = collection;
        window.serverTimestamp = serverTimestamp;

    </script>
    <style>
        /* Custom font and basic styling */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Custom scrollbar for aesthetic */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #f97316; /* Orange-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #ffeac7; /* Lighter Orange */
        }
        .message-pre {
            white-space: pre-wrap; /* Preserve whitespace and wrap lines */
            font-family: 'Noto Sans TC', monospace;
            line-height: 1.5;
            font-size: 0.875rem; /* text-sm */
        }
    </style>
    <script>
        // --- APP DATA AND STATE ---
        const EXTRA_CHARGE = 10; // åŠ é‡è²»ç”¨ NT$10
        
        const menuData = [
            // --- ç‚’é£¯é¡ (Fried Rice) ---
            { id: 'FR1', name: 'è‚‰çµ²ç‚’é£¯', price: 70, category: 'ç‚’é£¯é¡', description: 'ç¶“å…¸è‚‰çµ²ï¼Œç±³ç²’åˆ†æ˜' },
            { id: 'FR2', name: 'è¦ä»è›‹ç‚’é£¯', price: 80, category: 'ç‚’é£¯é¡', description: 'Qå½ˆè¦ä»ï¼Œé‡‘é»ƒè›‹èŠ±' },
            { id: 'FR3', name: 'é¦™è…¸è›‹ç‚’é£¯', price: 75, category: 'ç‚’é£¯é¡', description: 'å°å¼é¦™è…¸ï¼Œé¢¨å‘³ç¨ç‰¹' },
            { id: 'FR4', name: 'ç«è…¿è›‹ç‚’é£¯', price: 75, category: 'ç‚’é£¯é¡', description: 'ç«è…¿ä¸ï¼Œç¶“å…¸å£å‘³' },
            { id: 'FR5', name: 'åŸ¹æ ¹è›‹ç‚’é£¯', price: 75, category: 'ç‚’é£¯é¡', description: 'åŸ¹æ ¹é¦™æ°£ï¼Œå£æ„Ÿè±å¯Œ' },
            { id: 'FR6', name: 'é›è‚‰è›‹ç‚’é£¯', price: 75, category: 'ç‚’é£¯é¡', description: 'é®®å«©é›è‚‰ï¼Œå®¶å¸¸ç¾å‘³' },
            { id: 'FR7', name: 'å®®ä¿é›ä¸ç‚’é£¯', price: 80, category: 'ç‚’é£¯é¡', description: 'å¾®è¾£å®®ä¿é†¬æ±' },
            { id: 'FR8', name: 'éº»æ²¹é›ä¸è›‹ç‚’é£¯', price: 80, category: 'ç‚’é£¯é¡', description: 'æ¿ƒéƒéº»æ²¹é¦™ï¼Œæ»‹è£œæº«æš–' },
            { id: 'FR9', name: 'é’æ¤’è‚‰çµ²ç‚’é£¯', price: 80, category: 'ç‚’é£¯é¡', description: 'é’æ¤’è‚‰çµ²ï¼Œé¦™æ°£å››æº¢' },
            { id: 'FR10', name: 'ç‰›è‚‰è›‹ç‚’é£¯', price: 85, category: 'ç‚’é£¯é¡', description: 'é®®å«©ç‰›è‚‰ï¼Œé¢¨å‘³æ¿ƒéƒ' },
            { id: 'FR11', name: 'é’æ¤’ç‰›è‚‰è›‹ç‚’é£¯', price: 90, category: 'ç‚’é£¯é¡', description: 'é’æ¤’ç‰›è‚‰ï¼Œå¤§ä»½æ»¿è¶³' },

            // --- è“‹é£¯/ç‡´é£¯ (Covered Rice / Gravy Rice) ---
            { id: 'CR1', name: 'æ—¥å¼è±¬è‚‰è“‹é£¯', price: 90, category: 'è“‹é£¯/ç‡´é£¯', description: 'æ—¥å¼é†¬æ±ï¼Œæ»‘å«©è±¬è‚‰' },
            { id: 'CR2', name: 'æ—¥å¼é›è‚‰è“‹é£¯', price: 90, category: 'è“‹é£¯/ç‡´é£¯', description: 'æ—¥å¼é†¬æ±ï¼Œé®®å«©é›è‚‰' },
            { id: 'CR3', name: 'æ—¥å¼æµ·é®®è“‹é£¯', price: 90, category: 'è“‹é£¯/ç‡´é£¯', description: 'æ—¥å¼é†¬æ±ï¼Œè±å¯Œæµ·é®®' },
            { id: 'CR4', name: 'æ—¥å¼ç‰›è‚‰è“‹é£¯', price: 90, category: 'è“‹é£¯/ç‡´é£¯', description: 'æ—¥å¼é†¬æ±ï¼Œé®®å«©ç‰›è‚‰' },
            { id: 'CR5', name: 'å®®ä¿é›ä¸è“‹é£¯', price: 90, category: 'è“‹é£¯/ç‡´é£¯', description: 'å¾®è¾£å®®ä¿é†¬æ±ï¼Œé…é£¯é¦–é¸' },
            { id: 'CR6', name: 'è¾£å­é›ä¸è“‹é£¯', price: 90, category: 'è“‹é£¯/ç‡´é£¯', description: 'é¦™è¾£å¤ å‘³ï¼Œé–‹èƒƒé¸æ“‡' },
            { id: 'CR7', name: 'ä¸‰æ¯é›ä¸è“‹é£¯', price: 90, category: 'è“‹é£¯/ç‡´é£¯', description: 'ä¹å±¤å¡”é¦™æ°£ï¼Œå°ç£å‘³' },
            { id: 'CR8', name: 'éº»å©†é›ä¸è“‹é£¯', price: 90, category: 'è“‹é£¯/ç‡´é£¯', description: 'éº»è¾£è±†è…ï¼Œæ¿ƒéƒé†¬æ±' },
            { id: 'CR9', name: 'ç´…ç‡’è±†è…è“‹é£¯', price: 90, category: 'è“‹é£¯/ç‡´é£¯', description: 'ç¶“å…¸ç´…ç‡’ï¼Œé¹¹é¦™ä¸‹é£¯' },

            // --- ç‚’éºµ/çƒé¾ (Wok-Fried Noodles) ---
            { id: 'N1', name: 'è‚‰çµ²ç‚’éºµ', price: 70, category: 'ç‚’éºµ/çƒé¾', description: 'ç¶“å…¸è‚‰çµ²ï¼Œå¤§ç«å¿«ç‚’' },
            { id: 'N2', name: 'æµ·é®®ç‚’éºµ', price: 75, category: 'ç‚’éºµ/çƒé¾', description: 'æ–°é®®æµ·é®®ï¼Œå£æ„Ÿè±å¯Œ' },
            { id: 'N3', name: 'è¦ä»ç‚’éºµ', price: 75, category: 'ç‚’éºµ/çƒé¾', description: 'Qå½ˆè¦ä»ï¼Œé®®ç”œç¾å‘³' },
            { id: 'N4', name: 'è›¤ä»”ç‚’éºµ', price: 75, category: 'ç‚’éºµ/çƒé¾', description: 'è›¤èœŠé®®å‘³ï¼Œæ¸…çˆ½æ¹¯é ­' },
            { id: 'N5', name: 'ç‚’çƒé¾', price: 75, category: 'ç‚’éºµ/çƒé¾', description: 'Qå½ˆçƒé¾éºµï¼Œå¤§ç«å¿«ç‚’' },
            { id: 'N6', name: 'ç‰›è‚‰ç‚’éºµ', price: 85, category: 'ç‚’éºµ/çƒé¾', description: 'é®®å«©ç‰›è‚‰ï¼Œé¦™æ°£æ¿ƒéƒ' },
            { id: 'N7', name: 'æ²™èŒ¶ç‰›è‚‰ç‚’éºµ', price: 90, category: 'ç‚’éºµ/çƒé¾', description: 'æ²™èŒ¶é¢¨å‘³ï¼Œæ¿ƒéƒé¦™è¾£' },
            
            // --- ç‡´é£¯/å¿«ç‚’ (Gravy Rice / Wok-Fried Rice Dishes) ---
            { id: 'WR1', name: 'å®®ä¿é›ä¸ç‡´é£¯', price: 75, category: 'ç‡´é£¯/å¿«ç‚’', description: 'å¾®è¾£å®®ä¿é›ä¸ç‡´æ±ï¼Œé…é£¯é¦–é¸' },
            { id: 'WR2', name: 'è¾£å­é›ä¸ç‡´é£¯', price: 75, category: 'ç‡´é£¯/å¿«ç‚’', description: 'é¦™è¾£å¤ å‘³ç‡´æ±ï¼Œé–‹èƒƒä¸‹é£¯' },
            { id: 'WR3', name: 'ä¸‰æ¯é›ä¸ç‡´é£¯', price: 75, category: 'ç‡´é£¯/å¿«ç‚’', description: 'ä¹å±¤å¡”é¦™æ°£ä¸‰æ¯ç‡´æ±ï¼Œå°ç£å‘³' },
            { id: 'WR4', name: 'è”¥çˆ†è‚‰çµ²ç‡´é£¯', price: 75, category: 'ç‡´é£¯/å¿«ç‚’', description: 'è”¥çˆ†é¦™æ°£æ¿ƒéƒï¼Œç¶“å…¸ç‡´é£¯' },
            { id: 'WR5', name: 'æµ·é®®ä»€éŒ¦ç‡´é£¯', price: 80, category: 'ç‡´é£¯/å¿«ç‚’', description: 'è±å¯Œæµ·é®®é…æ–™ï¼Œé®®ç”œç‡´æ±' },
            { id: 'WR6', name: 'è”¥çˆ†ç‰›è‚‰ç‡´é£¯', price: 85, category: 'ç‡´é£¯/å¿«ç‚’', description: 'ç¶“å…¸è”¥çˆ†ï¼Œé®®å«©ç‰›è‚‰ç‡´é£¯' },
            { id: 'WR7', name: 'éº»å©†è±†è…ç‡´é£¯', price: 75, category: 'ç‡´é£¯/å¿«ç‚’', description: 'éº»è¾£è±†è…é†¬æ±ï¼Œé¦™æ¿ƒä¸‹é£¯' },
            { id: 'WR8', name: 'ç´…ç‡’è±†è…ç‡´é£¯', price: 75, category: 'ç‡´é£¯/å¿«ç‚’', description: 'ç´…ç‡’è±†è…é†¬æ±ï¼Œé¹¹é¦™å›å‘³' },

            // --- éŸ“å¼æ³¡èœé¡ (Kimchi Dishes) ---
            { id: 'KC1', name: 'æ³¡èœè±¬è‚‰é£¯', price: 80, category: 'éŸ“å¼æ³¡èœé¡', description: 'é…¸è¾£æ³¡èœç‚’è±¬è‚‰ï¼Œé™„ç™½é£¯' },
            { id: 'KC2', name: 'æ³¡èœè¦ä»ç‚’é£¯', price: 80, category: 'éŸ“å¼æ³¡èœé¡', description: 'é…¸è¾£æ³¡èœé¢¨å‘³ç‚’é£¯' },
            { id: 'KC3', name: 'æ³¡èœé¦™è…¸ç‚’é£¯', price: 80, category: 'éŸ“å¼æ³¡èœé¡', description: 'é…¸è¾£æ³¡èœèˆ‡é¦™è…¸' },
            { id: 'KC4', name: 'æ³¡èœé›è‚‰ç‚’é£¯', price: 80, category: 'éŸ“å¼æ³¡èœé¡', description: 'é…¸è¾£æ³¡èœèˆ‡é›è‚‰ä¸' },
            { id: 'KC5', name: 'æ³¡èœç«è…¿ç‚’é£¯', price: 80, category: 'éŸ“å¼æ³¡èœé¡', description: 'é…¸è¾£æ³¡èœèˆ‡ç«è…¿' },
            { id: 'KC6', name: 'æ³¡èœåŸ¹æ ¹ç‚’é£¯', price: 80, category: 'éŸ“å¼æ³¡èœé¡', description: 'é…¸è¾£æ³¡èœèˆ‡åŸ¹æ ¹' },
            { id: 'KC7', name: 'æ³¡èœç‰›è‚‰ç‚’é£¯', price: 90, category: 'éŸ“å¼æ³¡èœé¡', description: 'é…¸è¾£æ³¡èœèˆ‡ç‰›è‚‰' },
            { id: 'KC8', name: 'æ³¡èœè±¬è‚‰ç‚’éºµ', price: 80, category: 'éŸ“å¼æ³¡èœé¡', description: 'é…¸è¾£æ³¡èœç‚’è±¬è‚‰éºµ' },
            { id: 'KC9', name: 'æ³¡èœæµ·é®®ç‚’éºµ', price: 80, category: 'éŸ“å¼æ³¡èœé¡', description: 'é…¸è¾£æ³¡èœæµ·é®®ç‚’éºµ' },
            { id: 'KC10', name: 'æ³¡èœç‚’çƒé¾éºµ', price: 80, category: 'éŸ“å¼æ³¡èœé¡', description: 'é…¸è¾£æ³¡èœç‚’çƒé¾' },

            // --- é‹ç‡’é¡ (Noodle in Soup) ---
            { id: 'NS1', name: 'é‹ç‡’æ„éºµ', price: 80, category: 'é‹ç‡’é¡', description: 'ç¶“å…¸æ„éºµï¼Œè±å¯Œé…æ–™' },
            { id: 'NS2', name: 'é‹ç‡’å†¬ç²‰', price: 80, category: 'é‹ç‡’é¡', description: 'æ¸…çˆ½å†¬ç²‰ï¼Œæš–èƒƒæ¹¯é ­' },
            { id: 'NS3', name: 'é‹ç‡’çƒé¾éºµ', price: 80, category: 'é‹ç‡’é¡', description: 'Qå½ˆçƒé¾éºµï¼Œé®®ç¾æ¹¯é ­' },
            { id: 'NS4', name: 'å‘³å™Œçƒé¾éºµ', price: 80, category: 'é‹ç‡’é¡', description: 'æ—¥å¼å‘³å™Œæ¹¯é ­' },
            { id: 'NS5', name: 'é‹ç‡’æµ·é®®ç²¥', price: 80, category: 'é‹ç‡’é¡', description: 'æ–°é®®æµ·é®®ï¼Œæ¿ƒéƒç²¥åº•' },
            
            // --- ç²¾ç·»å¥—é¤ (Set Meals) ---
            { id: 'SM1', name: 'å®®ä¿é›ä¸å¥—é¤', price: 260, category: 'ç²¾ç·»å¥—é¤', description: 'é™„ç™½é£¯(ä¸Šé™ä¸‰ç¢—)ã€ä¸‰æ¨£é…èœåŠæ¯æ—¥æ¨è–¦æ¹¯' },
            { id: 'SM2', name: 'ä¸‰æ¯é›ä¸å¥—é¤', price: 260, category: 'ç²¾ç·»å¥—é¤', description: 'é™„ç™½é£¯(ä¸Šé™ä¸‰ç¢—)ã€ä¸‰æ¨£é…èœåŠæ¯æ—¥æ¨è–¦æ¹¯' },
            { id: 'SM3', name: 'è”¥çˆ†è±¬å¥—é¤', price: 260, category: 'ç²¾ç·»å¥—é¤', description: 'é™„ç™½é£¯(ä¸Šé™ä¸‰ç¢—)ã€ä¸‰æ¨£é…èœåŠæ¯æ—¥æ¨è–¦æ¹¯' },
            { id: 'SM4', name: 'è”¥çˆ†ç‰›å¥—é¤', price: 270, category: 'ç²¾ç·»å¥—é¤', description: 'é™„ç™½é£¯(ä¸Šé™ä¸‰ç¢—)ã€ä¸‰æ¨£é…èœåŠæ¯æ—¥æ¨è–¦æ¹¯' },

            // --- æ¹¯é¡ (Soup) ---
            { id: 'SP1', name: 'å‘³å™Œè±†è…æ¹¯', price: 20, category: 'æ¹¯é¡', description: 'æ—¥å¼ç¶“å…¸ï¼Œæ¸…æ·¡å£å‘³' },
            { id: 'SP2', name: 'è›‹èŠ±æ¹¯', price: 25, category: 'æ¹¯é¡', description: 'æ»‘å«©è›‹èŠ±ï¼Œå®¶å¸¸å¥½å‘³' },
            { id: 'SP3', name: 'è²¢ä¸¸æ¹¯', price: 35, category: 'æ¹¯é¡', description: 'å½ˆç‰™è²¢ä¸¸ï¼Œæ¹¯é ­æ¸…ç”œ' },
            { id: 'SP4', name: 'é­šä¸¸æ¹¯', price: 35, category: 'æ¹¯é¡', description: 'é®®ç¾é­šä¸¸ï¼Œæ¸…çˆ½ä¸è†©' },
            { id: 'SP5', name: 'å‘³å™Œè›¤ä»”æ¹¯', price: 50, category: 'æ¹¯é¡', description: 'å‘³å™Œèˆ‡è›¤èœŠçš„çµåˆ' },
            { id: 'SP6', name: 'è›¤ä»”æ¹¯', price: 30, category: 'æ¹¯é¡', description: 'åŸå‘³è›¤èœŠï¼Œé®®ç”œæš–èƒƒ' },
            { id: 'SP7', name: 'é®®ç¾è›¤ä»”æ¹¯', price: 50, category: 'æ¹¯é¡', description: 'æ–°é®®è›¤èœŠï¼Œå‡ç´šä»½é‡æˆ–åŠ æ–™' },

            // --- å–®é»å°ç‚’ (Side Dishes) ---
            { id: 'SD1', name: 'æ™‚ä»¤é’èœ', price: 40, category: 'å–®é»/å°èœ', description: 'æ–°é®®æ™‚ä»¤è”¬èœï¼Œè«‹ä¾ç¾å ´æ™‚åƒ¹ï¼Œæš«å®š40å…ƒ' },
            { id: 'SD2', name: 'ç™½é£¯', price: 10, category: 'å–®é»/å°èœ', description: 'é¦™Qç™½é£¯' },
            { id: 'SD3', name: 'è”¥èŠ±è›‹', price: 40, category: 'å–®é»/å°èœ', description: 'è”¥èŠ±èˆ‡è›‹çš„å®Œç¾çµåˆ' },
            { id: 'SD4', name: 'ä¹å±¤å¡”è›‹', price: 40, category: 'å–®é»/å°èœ', description: 'ä¹å±¤å¡”é¦™æ°£åè¶³' },
            { id: 'SD5', name: 'èœè„¯è›‹', price: 40, category: 'å–®é»/å°èœ', description: 'èœè„¯ä¸å¢åŠ å£æ„Ÿ' },
            { id: 'SD6', name: 'æ´‹è”¥ç‚’è›‹', price: 60, category: 'å–®é»/å°èœ', description: 'æ´‹è”¥çš„ç”œå‘³èˆ‡ç‚’è›‹' },
            { id: 'SD7', name: 'è¦ä»çƒ˜è›‹', price: 70, category: 'å–®é»/å°èœ', description: 'è¦ä»èˆ‡åšå¯¦çƒ˜è›‹' },
            { id: 'SD8', name: 'éº»å©†è±†è…', price: 75, category: 'å–®é»/å°èœ', description: 'å–®é»èœé¤šï¼Œç„¡é™„é£¯' }, 
            { id: 'SD9', name: 'ç´…ç‡’è±†è…', price: 75, category: 'å–®é»/å°èœ', description: 'å–®é»èœé¤šï¼Œç„¡é™„é£¯' },
            { id: 'SD10', name: 'é’æ¤’è‚‰çµ²', price: 75, category: 'å–®é»/å°èœ', description: 'å–®é»èœé¤šï¼Œç„¡é™„é£¯' },
            { id: 'SD11', name: 'å®®ä¿é›ä¸', price: 75, category: 'å–®é»/å°èœ', description: 'å–®é»èœé¤šï¼Œç„¡é™„é£¯' },
            { id: 'SD12', name: 'ä¸‰æ¯é›ä¸', price: 75, category: 'å–®é»/å°èœ', description: 'å–®é»èœé¤šï¼Œç„¡é™„é£¯' },
            { id: 'SD13', name: 'è¾£å­é›ä¸', price: 75, category: 'å–®é»/å°èœ', description: 'å–®é»èœé¤šï¼Œç„¡é™„é£¯' },
            { id: 'SD14', name: 'è”¥çˆ†è±¬', price: 75, category: 'å–®é»/å°èœ', description: 'å–®é»èœé¤šï¼Œç„¡é™„é£¯' },
            { id: 'SD15', name: 'è”¥çˆ†é›', price: 75, category: 'å–®é»/å°èœ', description: 'å–®é»èœé¤šï¼Œç„¡é™„é£¯' },
            { id: 'SD16', name: 'æ³¡èœè±¬è‚‰', price: 80, category: 'å–®é»/å°èœ', description: 'å–®é»èœé¤šï¼Œç„¡é™„é£¯' },
            { id: 'SD17', name: 'è”¥çˆ†ç‰›è‚‰', price: 85, category: 'å–®é»/å°èœ', description: 'å–®é»èœé¤šï¼Œç„¡é™„é£¯' },
            { id: 'SD18', name: 'ç³–é†‹é›ä¸', price: 85, category: 'å–®é»/å°èœ', description: 'å–®é»èœé¤šï¼Œç„¡é™„é£¯' },
            { id: 'SD19', name: 'é’æ¤’ç‰›è‚‰', price: 90, category: 'å–®é»/å°èœ', description: 'å–®é»èœé¤šï¼Œç„¡é™„é£¯' },
            { id: 'SD20', name: 'æ³¡èœç‰›è‚‰', price: 90, category: 'å–®é»/å°èœ', description: 'å–®é»èœé¤šï¼Œç„¡é™„é£¯' },
        ];

        let cart = {}; // { uniqueKey: { item, quantity, isExtra, isSpicy, noGreenOnion, price, uniqueKey } }
        let currentSelectedItem = null; // ç•¶å‰åœ¨ Options Modal ä¸­é¸æ“‡çš„é …ç›®
        let tempOrderSubmissionData = null; // æš«å­˜ LINE å‚³é€æ‰€éœ€çš„è³‡æ–™ { lineUrl, docRefId }

        // --- UTILITY FUNCTIONS ---

        /**
         * Displays a temporary notification message in the corner.
         */
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const color = type === 'success' ? 'bg-green-500' : 'bg-red-500';

            notification.textContent = message;
            notification.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 z-50 ${color}`;
            notification.classList.remove('opacity-0', 'hidden');
            notification.classList.add('opacity-100');

            setTimeout(() => {
                notification.classList.remove('opacity-100');
                notification.classList.add('opacity-0');
                setTimeout(() => notification.classList.add('hidden'), 300);
            }, 3000);
        }

        /**
         * Formats a number to currency string (NTD format).
         */
        function formatCurrency(amount) {
            return '$' + amount.toLocaleString('zh-TW');
        }

        // --- CART & OPTIONS LOGIC ---

        /**
         * Opens the modal to select quantity and options for an item.
         * @param {string} itemId The ID of the item.
         */
        function openItemOptions(itemId) {
            const item = menuData.find(i => i.id === itemId);
            if (!item) return;

            currentSelectedItem = item;

            // Update modal title and details
            document.getElementById('item-modal-title').textContent = item.name;
            document.getElementById('item-modal-price').textContent = formatCurrency(item.price);
            document.getElementById('item-modal-extra-charge').textContent = `(åŠ é‡è²»ç”¨ ${formatCurrency(EXTRA_CHARGE)})`;
            document.getElementById('item-quantity-input').value = 1;
            
            // Reset all checkboxes
            document.getElementById('item-extra-checkbox').checked = false;
            document.getElementById('item-spicy-checkbox').checked = false;
            document.getElementById('item-no-green-onion-checkbox').checked = false; 


            // Show the modal
            toggleOptionsModal(true);
        }

        /**
         * Finalizes item addition to the cart from the options modal.
         */
        function addItemToCart() {
            if (!currentSelectedItem) return;

            const quantity = parseInt(document.getElementById('item-quantity-input').value, 10);
            const isExtra = document.getElementById('item-extra-checkbox').checked;
            const isSpicy = document.getElementById('item-spicy-checkbox').checked; 
            const noGreenOnion = document.getElementById('item-no-green-onion-checkbox').checked; 

            if (quantity < 1) {
                showNotification('æ•¸é‡è‡³å°‘ç‚º 1', 'error');
                return;
            }

            // æ›´æ–° uniqueKey ä»¥åŒ…å«æ‰€æœ‰é¸é …
            const uniqueKey = `${currentSelectedItem.id}-${isExtra}-${isSpicy}-${noGreenOnion}`;
            const finalPrice = currentSelectedItem.price + (isExtra ? EXTRA_CHARGE : 0);

            if (cart[uniqueKey]) {
                cart[uniqueKey].quantity += quantity;
            } else {
                cart[uniqueKey] = { 
                    id: currentSelectedItem.id,
                    name: currentSelectedItem.name,
                    price: currentSelectedItem.price, // Base price
                    finalPrice: finalPrice, // Price with extra charge
                    quantity: quantity, 
                    isExtra: isExtra,
                    isSpicy: isSpicy,
                    noGreenOnion: noGreenOnion, 
                    uniqueKey: uniqueKey
                };
            }

            // Close modal and update display
            toggleOptionsModal(false);
            updateCartDisplay();
            
            // æ§‹å»ºé€šçŸ¥è¨Šæ¯
            let optionsText = isExtra ? 'åŠ é‡' : 'ä¸€èˆ¬ä»½é‡';
            if (isSpicy) optionsText += ', åŠ è¾£';
            if (noGreenOnion) optionsText += ', ä¸åŠ è”¥'; 

            showNotification(`${currentSelectedItem.name} (${optionsText}) x${quantity} å·²åŠ å…¥è³¼ç‰©è»Š`, 'success');
            currentSelectedItem = null;
        }
        
        /**
         * Decrements the quantity of an item or removes it if quantity reaches 0.
         * @param {string} uniqueKey The unique key of the item variation to remove.
         */
        function removeFromCart(uniqueKey) {
            if (cart[uniqueKey]) {
                cart[uniqueKey].quantity -= 1;
                if (cart[uniqueKey].quantity <= 0) {
                    delete cart[uniqueKey];
                }
                updateCartDisplay();
            }
        }

        /**
         * Updates the cart badge count and total in the UI.
         */
        function updateCartDisplay() {
            const cartItems = Object.values(cart);
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            
            document.getElementById('cart-count').textContent = totalItems;
            
            // Update main checkout modal content if it's open (handles all totals)
            renderCartModalContent();
        }

        /**
         * Renders the cart contents inside the modal.
         * MODIFIED: Updated item display format to clearly show final unit price.
         */
        function renderCartModalContent() {
            const cartList = document.getElementById('cart-list');
            const cartItems = Object.values(cart);

            let html = '';
            const totalAmount = cartItems.reduce((sum, item) => sum + item.quantity * item.finalPrice, 0);
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0); 
            
            document.getElementById('cart-total-amount').textContent = formatCurrency(totalAmount);
            
            // Update total items display in the modal
            const cartTotalItemsEl = document.getElementById('cart-total-items');
            if (cartTotalItemsEl) {
                cartTotalItemsEl.textContent = `${totalItems} ä»½`;
            }


            if (cartItems.length === 0) {
                html = '<p class="text-gray-500 text-center py-8">è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œå¿«å»é»é¤å§ï¼</p>';
                document.getElementById('checkout-button').disabled = true;
                document.getElementById('checkout-button').classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('customer-input-container').classList.add('hidden'); 
            } else {
                document.getElementById('checkout-button').disabled = false;
                document.getElementById('checkout-button').classList.remove('opacity-50', 'cursor-not-allowed');
                document.getElementById('customer-input-container').classList.remove('hidden');

                cartItems.forEach(item => {
                    // çµ„åˆæ‰€æœ‰é¸é …çš„é¡¯ç¤ºæ–‡å­—
                    let optionText = '';
                    if (item.isExtra) optionText += '<span class="text-red-500 font-medium">åŠ é‡+$10</span>';
                    if (item.isSpicy) {
                        optionText += (optionText ? ' / ' : '') + '<span class="text-red-600 font-medium">åŠ è¾£ğŸŒ¶ï¸</span>';
                    }
                    if (item.noGreenOnion) {
                        optionText += (optionText ? ' / ' : '') + '<span class="text-gray-600 font-medium">ä¸åŠ è”¥ğŸŒ¿</span>';
                    }

                    const subtotal = item.finalPrice * item.quantity;
                    
                    html += `
                        <div class="flex items-center justify-between p-4 border-b border-orange-100 last:border-b-0">
                            <div class="flex-1 min-w-0">
                                <!-- DISPLAY: Name (Final Price) -->
                                <p class="font-semibold text-lg text-gray-800 truncate flex-shrink">
                                    ${item.name} 
                                    <span class="text-orange-600 font-bold ml-1">(${formatCurrency(item.finalPrice)})</span>
                                </p>
                                <!-- DISPLAY: Options -->
                                <p class="text-sm text-gray-500">${optionText}</p>
                            </div>
                            <!-- Subtotal display next to controls -->
                            <p class="text-lg font-bold text-red-600 ml-4 hidden sm:block">${formatCurrency(subtotal)}</p>

                            <div class="flex items-center space-x-2 ml-4 flex-shrink-0">
                                <button onclick="removeFromCart('${item.uniqueKey}')" class="w-8 h-8 flex items-center justify-center bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition duration-150 active:scale-95">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <span class="font-bold text-gray-800 w-6 text-center">${item.quantity}</span>
                                <button onclick="openItemOptions('${item.id}')" class="w-8 h-8 flex items-center justify-center bg-orange-100 text-orange-600 rounded-full hover:bg-orange-200 transition duration-150 active:scale-95">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            cartList.innerHTML = html;
        }

        // --- ORDER SUBMISSION AND LINE INTEGRATION ---
        
        /**
         * æ­¥é©Ÿ 1: é©—è­‰è¡¨å–®ï¼Œå„²å­˜è‡³ Firestoreï¼Œä¸¦é¡¯ç¤ºç¢ºèªè¦–çª—ã€‚
         * MODIFIED: Updated item description in the LINE message to remove subtotal.
         */
        async function prepareOrderAndShowConfirmation() {
            // å–å¾—è¼¸å…¥æ¬„ä½
            const orderType = document.getElementById('order-type-select').value.trim(); 
            const notes = document.getElementById('notes-input').value.trim(); 
            const deliveryInfo = document.getElementById('delivery-info-input').value.trim();
            
            if (Object.keys(cart).length === 0) {
                showNotification('è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œç„¡æ³•é€å‡ºè¨‚å–®', 'error');
                return;
            }
            
            // é©—è­‰å¿…å¡«æ¬„ä½
            if (!orderType) {
                showNotification('è«‹é¸æ“‡è¨‚å–®é¡å‹ (è‡ªå–/å¤–é€)ï¼', 'error');
                document.getElementById('order-type-select').focus();
                return;
            }

            if (!deliveryInfo) {
                showNotification('è«‹è¼¸å…¥å…¬å¸/é›»è©±/åœ°å€ (å¿…å¡«æ¬„ä½)ï¼', 'error');
                document.getElementById('delivery-info-input').focus();
                return;
            }


            const totalAmount = Object.values(cart).reduce((sum, item) => sum + item.quantity * item.finalPrice, 0);
            const totalItems = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
            let docRefId = 'N/A (é›¢ç·šæ¨¡å¼)';

            document.getElementById('loading-overlay').classList.remove('hidden');

            // --- 1. å˜—è©¦å‚™ä»½è‡³ Firestore ---
            if (window.isFirebaseReady && window.db && window.currentUserId) {
                const orderData = {
                    userId: window.currentUserId,
                    appId: window.appId,
                    orderType: orderType, 
                    deliveryInfo: deliveryInfo, 
                    notes: notes, 
                    items: Object.values(cart).map(item => ({
                        id: item.id,
                        name: item.name,
                        option: `${item.isExtra ? 'åŠ é‡' : 'ä¸€èˆ¬'}${item.isSpicy ? '/åŠ è¾£' : ''}${item.noGreenOnion ? '/ä¸åŠ è”¥' : ''}`, 
                        isExtra: item.isExtra,
                        isSpicy: item.isSpicy,
                        noGreenOnion: item.noGreenOnion, 
                        basePrice: item.price,
                        finalPrice: item.finalPrice,
                        quantity: item.quantity,
                        subtotal: item.finalPrice * item.quantity
                    })),
                    totalAmount: totalAmount,
                    totalItems: totalItems, 
                    status: 'Pending',
                    createdAt: window.serverTimestamp()
                };

                const path = `artifacts/${window.appId}/users/${window.currentUserId}/orders`;

                try {
                    const docRef = await window.addDoc(window.collection(window.db, path), orderData);
                    docRefId = docRef.id;
                    showNotification(`è¨‚å–®å·²å‚™ä»½è‡³é›²ç«¯ (ID: ${docRefId})`, 'success');
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showNotification(`é›²ç«¯å‚™ä»½å¤±æ•—ï¼š${e.message}ã€‚è¨‚å–®å°‡é€é LINE å‚³é€ã€‚`, 'error');
                }
            } else {
                 showNotification(`é›²ç«¯å‚™ä»½å·²è·³é (é›¢ç·šæ¨¡å¼)ã€‚`, 'error');
            }

            // --- 2. æ§‹å»º LINE è¨Šæ¯ ---
            let messageText = `ã€çé¦™å°é¤¨ - æ–°è¨‚å–®ã€‘\n`;
            messageText += `==========================\n`;
            messageText += `ğŸ›ï¸ è¨‚å–®é¡å‹: ${orderType}\n`; 
            messageText += `ğŸ“ å®¢æˆ¶/å¤–é€è³‡è¨Š: ${deliveryInfo}\n`;
            messageText += `ğŸ“ å‚™è¨» (é€é”/è¦æ±‚): ${notes || 'ç„¡'}\n`; 
            messageText += `--------------------------\n`;
            messageText += `ğŸ’° ç¸½é‡‘é¡: ${formatCurrency(totalAmount)}\n`;
            messageText += `ğŸ”¢ åˆè¨ˆæ•¸é‡: ${totalItems} ä»½\n`; 
            messageText += `ğŸ“œ è¨‚å–®è©³æƒ…:\n`;

            Object.values(cart).forEach(item => {
                let optionText = '';
                if (item.isExtra) optionText += ' (åŠ é‡)';
                if (item.isSpicy) optionText += ' (åŠ è¾£)';
                if (item.noGreenOnion) optionText += ' (ä¸åŠ è”¥)'; 
                
                // *** UPDATED FORMAT: ItemName(FinalPrice) [Options] x Quantity ***
                messageText += 
                    ` > ${item.name} (${formatCurrency(item.finalPrice)})${optionText} ` + 
                    `x ${item.quantity}\n`; // <-- REMOVED subtotal
            });

            messageText += `--------------------------\n`;
            messageText += `(åƒè€ƒID: ${docRefId}) è«‹å‚³é€çµ¦ LINE ID: joe690130`;

            const lineMessage = encodeURIComponent(messageText);
            const lineUrl = `https://line.me/R/share?text=${lineMessage}`;

            // --- 3. æº–å‚™ä¸¦é¡¯ç¤ºç¢ºèªè¦–çª— ---
            tempOrderSubmissionData = { lineUrl, docRefId, totalAmount };

            // å¡«å……ç¢ºèªè¦–çª—çš„å…§å®¹
            document.getElementById('confirmation-message-display').textContent = messageText;
            document.getElementById('confirmation-total-amount').textContent = formatCurrency(totalAmount);
            document.getElementById('confirmation-doc-id').textContent = `é›²ç«¯åƒè€ƒID: ${docRefId}`;

            // é—œé–‰è³¼ç‰©è»Šè¦–çª—ï¼Œé–‹å•Ÿç¢ºèªè¦–çª—
            document.getElementById('loading-overlay').classList.add('hidden');
            toggleCartModal(false);
            toggleConfirmationModal(true);
        }
        
        /**
         * æ­¥é©Ÿ 2: ç¢ºèªä¸¦é€é LINE å‚³é€è¨‚å–®ã€‚
         */
        function sendOrderViaLine() {
            if (!tempOrderSubmissionData) {
                showNotification('è¨‚å–®è³‡æ–™éºå¤±ï¼Œè«‹é‡æ–°é»é¤ã€‚', 'error');
                return;
            }
            
            // 1. å–å¾—è³‡æ–™
            const { lineUrl, docRefId } = tempOrderSubmissionData;
            
            // 2. æ¸…ç† (é‡ç½®è³¼ç‰©è»Šã€è¼¸å…¥æ¬„ä½ã€é—œé–‰è¦–çª—)
            document.getElementById('delivery-info-input').value = ''; 
            document.getElementById('notes-input').value = ''; 
            document.getElementById('order-type-select').value = ''; 
            cart = {};
            updateCartDisplay();
            toggleConfirmationModal(false); // é—œé–‰ç¢ºèªè¦–çª—
            
            showNotification(`è«‹åˆ‡æ›è‡³ LINE è¦–çª—æ‰‹å‹•å‚³é€è¨Šæ¯çµ¦ joe690130 å®Œæˆé€šçŸ¥ï¼`, 'success');
                    
            // 3. è·³è½‰è‡³ LINE
            window.open(lineUrl, '_blank');
            
            // 4. æ¸…ç†æš«å­˜è³‡æ–™
            tempOrderSubmissionData = null;
        }


        // --- UI RENDERING ---
        function renderMenu() {
            const menuContainer = document.getElementById('menu-container');
            const categoryOrder = [
                'ç‚’é£¯é¡', 'è“‹é£¯/ç‡´é£¯', 'ç‚’éºµ/çƒé¾', 'ç‡´é£¯/å¿«ç‚’', 'éŸ“å¼æ³¡èœé¡', 
                'é‹ç‡’é¡', 'ç²¾ç·»å¥—é¤', 'å–®é»/å°èœ', 'æ¹¯é¡'
            ];
            const categories = categoryOrder.filter(c => menuData.some(item => item.category === c));
            let html = '';

            categories.forEach(category => {
                const items = menuData.filter(item => item.category === category);
                html += `
                    <div id="${category}" class="mt-8">
                        <!-- é¡åˆ¥æ¨™é¡Œè¨­è¨ˆ - å­—é«”æ”¾å¤§, åŠ ä¸Šæ©˜è‰²åº•è‰², åœ“è§’èˆ‡é™°å½± -->
                        <h2 class="text-3xl sm:text-4xl font-extrabold text-orange-800 mb-6 bg-orange-200 p-4 rounded-xl shadow-md tracking-tight">
                            ${category}
                        </h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                `;
                items.forEach(item => {
                    // *** UPDATED CARD STRUCTURE for Price Alignment ***
                    html += `
                        <div class="bg-white rounded-xl p-4 shadow-md hover:shadow-lg transition duration-200 flex items-center justify-between">
                            
                            <!-- 1. Item Name (Flexible width to take up space) -->
                            <h3 class="text-lg sm:text-xl font-bold text-gray-800 truncate flex-grow min-w-[30%]">${item.name}</h3>

                            <!-- 2. Price (Fixed width w-20 and Right-Aligned for Alignment) -->
                            <div class="text-right w-20 flex-shrink-0 mx-2">
                                <span class="text-xl font-extrabold text-orange-600">${formatCurrency(item.price)}</span>
                            </div>

                            <!-- 3. Button (Fixed width) -->
                            <button onclick="openItemOptions('${item.id}')"
                                class="px-3 py-1.5 bg-orange-500 text-white font-semibold rounded-full shadow-md hover:bg-orange-600 transition duration-150 active:scale-95 flex items-center space-x-1 text-sm flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                                <span>é»é¤/é¸é‡</span>
                            </button>
                        </div>
                    `;
                    // *** END: UPDATED CARD STRUCTURE ***
                });
                html += '</div></div>';
            });
            menuContainer.innerHTML = html;
        }

        /**
         * Toggles the main cart modal visibility.
         */
        function toggleCartModal(show) {
            const modal = document.getElementById('cart-modal');
            if (show) {
                renderCartModalContent();
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.querySelector('.modal-content').classList.remove('opacity-0', 'translate-y-4');
                    modal.classList.add('bg-black', 'bg-opacity-50');
                }, 10);
            } else {
                modal.querySelector('.modal-content').classList.add('opacity-0', 'translate-y-4');
                modal.classList.remove('bg-black', 'bg-opacity-50');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }
        
        /**
         * Toggles the item options modal visibility.
         */
        function toggleOptionsModal(show) {
            const modal = document.getElementById('item-options-modal');
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => { 
                    modal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
                    modal.classList.add('bg-black', 'bg-opacity-50');
                }, 10);
            } else {
                modal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
                modal.classList.remove('bg-black', 'bg-opacity-50');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        /**
         * Toggles the order confirmation modal visibility.
         */
        function toggleConfirmationModal(show) {
            const modal = document.getElementById('order-confirmation-modal');
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => { 
                    modal.querySelector('.modal-content').classList.remove('opacity-0', 'translate-y-4');
                    modal.classList.add('bg-black', 'bg-opacity-50');
                }, 10);
            } else {
                modal.querySelector('.modal-content').classList.add('opacity-0', 'translate-y-4');
                modal.classList.remove('bg-black', 'bg-opacity-50');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }


        // --- INITIALIZATION ---
        window.onload = async () => {
            await window.initializeFirebase();
            renderMenu(); 
            updateCartDisplay();
        };

        // Expose functions globally
        window.openItemOptions = openItemOptions;
        window.addItemToCart = addItemToCart;
        window.removeFromCart = removeFromCart;
        window.toggleCartModal = toggleCartModal;
        window.toggleOptionsModal = toggleOptionsModal;
        window.toggleConfirmationModal = toggleConfirmationModal;
        window.prepareOrderAndShowConfirmation = prepareOrderAndShowConfirmation; // Renamed
        window.submitOrder = prepareOrderAndShowConfirmation; // For compatibility with button
        window.sendOrderViaLine = sendOrderViaLine; // New final step
    </script>
</head>
<body class="min-h-screen">

    <!-- Header & Navigation (Contact and hours info) -->
    <header class="sticky top-0 bg-white shadow-lg z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-start">
            
            <!-- Title and Contact/Hours Block -->
            <div class="flex-1 min-w-0">
                <h1 class="text-3xl font-extrabold text-orange-600 tracking-tight">
                    çé¦™å°é¤¨
                    <span class="text-sm text-gray-500 font-normal block">ç·šä¸Šé»é¤æœå‹™</span>
                </h1>
                
                <!-- NEW INFORMATION BLOCK (Based on the uploaded image) -->
                <div class="mt-2 text-sm text-gray-700 space-y-1">
                    <p class="font-semibold text-base flex items-center">
                        <svg class="w-4 h-4 mr-2 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                        å¤–é€å°ˆç·š: <a href="tel:076258204" class="font-extrabold text-red-600 ml-1 hover:underline">07-6258204</a>
                    </p>
                    <p class="flex items-center">
                        <svg class="w-4 h-4 mr-2 text-orange-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        åœ°å€: <a href="https://maps.app.goo.gl/example" target="_blank" class="hover:underline">å²¡å±±å€å…¬åœ’è¥¿è·¯ä¸‰æ®µ109è™Ÿ</a>
                    </p>
                    <p class="flex items-center font-bold text-gray-800">
                        <svg class="w-4 h-4 mr-2 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        ç‡Ÿæ¥­æ™‚é–“:
                        <span class="ml-1 text-green-700 font-extrabold">ä¸­: 10:30~13:00 / æ™š: 16:30~19:30</span>
                        <span class="ml-2 text-red-500 font-extrabold">(é€±ä¼‘äºŒæ—¥)</span>
                    </p>
                </div>
                <!-- END NEW INFORMATION BLOCK -->
            </div>

            <div class="flex items-center space-x-4 flex-shrink-0 ml-4">
                <span id="user-info" class="text-xs text-gray-500 hidden sm:block">è¼‰å…¥ç”¨æˆ¶ä¸­...</span>
                <button onclick="toggleCartModal(true)" class="relative p-3 bg-orange-500 rounded-full text-white shadow-xl hover:bg-orange-600 transition duration-150 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span id="cart-count" class="absolute -top-1 -right-1 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform bg-red-600 rounded-full">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content: Menu -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- LINE ID PROMINENT WARNING -->
        <div class="p-4 mb-8 bg-yellow-100 border-l-8 border-red-500 rounded-xl shadow-lg animate-pulse">
            <div class="flex items-center space-x-3">
                <!-- Warning Icon -->
                <svg class="h-8 w-8 text-red-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                <p class="text-xl font-extrabold text-red-700">
                    ğŸ“¢ è¨‚å–®å‚³é€æé†’ï¼š
                    <span class="block text-2xl font-black text-red-800 mt-1">
                        éœ€å…ˆåŠ å…¥çé¦™å°é¤¨ LINE æ‰èƒ½ç™¼é€è¨‚å–®ï¼
                    </span>
                    <span class="block text-xl font-extrabold text-red-600">
                        LINE ID: joe690130
                    </span>
                </p>
            </div>
        </div>
        <!-- END NEW WARNING -->

        <p class="text-lg text-gray-600 mb-6 border-b pb-4">
            è«‹é»é¸æ‚¨æƒ³é»çš„å“é …ã€‚é»é¤æ™‚å¯é¸æ“‡ **åŠ é‡ (+$${EXTRA_CHARGE})**ã€**åŠ è¾£**ã€**ä¸åŠ è”¥** ç­‰é¸é …ã€‚
        </p>
        <div id="menu-container">
            <div class="text-center py-20 text-gray-500">
                <p>èœå–®è¼‰å…¥ä¸­...</p>
                <div class="mt-4 animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mx-auto"></div>
            </div>
        </div>
    </main>
    
    <!-- Item Options Modal -->
    <div id="item-options-modal" class="fixed inset-0 hidden z-50 transition-all duration-300" onclick="if(event.target.id === 'item-options-modal') toggleOptionsModal(false)">
        <div class="flex items-center justify-center min-h-screen px-4 py-8">
            <div class="modal-content bg-white w-full max-w-sm rounded-xl shadow-2xl transform transition-all duration-300 opacity-0 scale-95" role="dialog">
                <div class="flex justify-between items-center p-4 bg-orange-500 rounded-t-xl">
                    <h3 id="item-modal-title" class="text-xl font-bold text-white">å“é …åç¨±</h3>
                    <button onclick="toggleOptionsModal(false)" class="text-white hover:text-orange-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="text-lg font-semibold text-gray-700">
                        å–®åƒ¹: <span id="item-modal-price" class="text-orange-600"></span>
                    </div>
                    <div>
                        <label for="item-quantity-input" class="block text-sm font-medium text-gray-700 mb-1">é¸æ“‡æ•¸é‡</label>
                        <input type="number" id="item-quantity-input" value="1" min="1" max="99" class="w-full p-3 border border-gray-300 rounded-lg text-center focus:ring-orange-500 focus:border-orange-500" />
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <label for="item-extra-checkbox" class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="item-extra-checkbox" class="h-5 w-5 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                            <span class="text-base font-semibold text-gray-800">æ˜¯å¦åŠ é‡</span>
                        </label>
                        <span id="item-modal-extra-charge" class="text-red-500 font-bold text-sm">(åŠ é‡è²»ç”¨ $10)</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <label for="item-spicy-checkbox" class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="item-spicy-checkbox" class="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <span class="text-base font-semibold text-gray-800">æ˜¯å¦åŠ è¾£ ğŸŒ¶ï¸</span>
                        </label>
                        <span class="text-gray-500 font-bold text-sm">(ä¸åŠ åƒ¹)</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <label for="item-no-green-onion-checkbox" class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="item-no-green-onion-checkbox" class="h-5 w-5 text-gray-600 border-gray-300 rounded focus:ring-gray-500">
                            <span class="text-base font-semibold text-gray-800">æ˜¯å¦ä¸åŠ è”¥ ğŸŒ¿</span>
                        </label>
                        <span class="text-gray-500 font-bold text-sm">(ä¸åŠ åƒ¹)</span>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-100">
                    <button onclick="addItemToCart()" class="w-full py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition duration-150 active:scale-[.99]">
                        åŠ å…¥è³¼ç‰©è»Š
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Modal (Checkout Pop-up) -->
    <div id="cart-modal" class="fixed inset-0 hidden z-40 transition-all duration-300" onclick="if(event.target.id === 'cart-modal') toggleCartModal(false)">
        <div class="flex items-center justify-center min-h-screen px-4 py-4 sm:py-8">
            <div class="modal-content bg-white w-full max-w-lg max-h-[90vh] flex flex-col rounded-xl shadow-2xl transform transition-all duration-300 opacity-0 translate-y-4" role="dialog">
                <div class="flex justify-between items-center p-6 bg-orange-500 rounded-t-xl flex-shrink-0">
                    <h3 id="modal-title" class="text-2xl font-bold text-white">æ‚¨çš„è¨‚å–®</h3>
                    <button onclick="toggleCartModal(false)" class="text-white hover:text-orange-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 pb-4 border-b border-gray-100 flex-shrink-0">
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between items-center text-2xl font-bold">
                            <span>ç¸½è¨ˆé‡‘é¡:</span>
                            <span id="cart-total-amount" class="text-orange-600">$0</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-semibold text-gray-700 border-t pt-2">
                            <span>åˆè¨ˆæ•¸é‡:</span>
                            <span id="cart-total-items" class="text-gray-900 font-extrabold">0 ä»½</span>
                        </div>
                    </div>
                    <button id="checkout-button" onclick="submitOrder()" class="w-full py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition duration-150 active:scale-[.99] disabled:opacity-50 disabled:cursor-not-allowed">
                        é€å‡ºè¨‚å–® & é€²è¡Œæ ¸å°
                    </button>
                    <p class="text-center text-sm text-gray-500 mt-2 mb-4">
                        é»æ“Šä¸Šæ–¹æŒ‰éˆ•ï¼Œå°‡æœƒé¡¯ç¤ºæ ¸å°è¦–çª—ï¼Œç¢ºèªç„¡èª¤å¾Œæ‰æœƒå‚³é€ã€‚
                    </p>
                    <!-- å®¢æˆ¶è³‡è¨Šè¼¸å…¥æ¬„ä½ -->
                    <div id="customer-input-container" class="space-y-3 border-t pt-4 hidden">
                        <!-- æ–°å¢ï¼šè‡ªå–/å¤–é€é¸é … -->
                        <select id="order-type-select" required class="w-full p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition">
                            <option value="">-- è«‹é¸æ“‡è¨‚å–®é¡å‹ (å¿…å¡«) --</option>
                            <option value="å¤–é€">å¤–é€ (Delivery)</option>
                            <option value="è‡ªå–">è‡ªå– (Pickup)</option>
                        </select>
                        <input type="text" id="delivery-info-input" placeholder="è¼¸å…¥å…¬å¸/é›»è©±/åœ°å€ (å¿…å¡«)" required class="w-full p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" />
                        <!-- ä¿®æ­£ï¼šå¸Œæœ›é€é”æ™‚é–“æ”¹ç‚ºå‚™è¨» -->
                        <textarea id="notes-input" placeholder="å‚™è¨» (ä¾‹: é€é”æ™‚é–“, ç‰¹æ®Šè¦æ±‚)" class="w-full p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition h-20 resize-none"></textarea>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto">
                    <div id="cart-list" class="divide-y divide-gray-100">
                        <!-- Cart items rendered here by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- NEW: Order Confirmation Modal -->
    <div id="order-confirmation-modal" class="fixed inset-0 hidden z-50 transition-all duration-300" onclick="if(event.target.id === 'order-confirmation-modal') toggleConfirmationModal(false)">
        <div class="flex items-center justify-center min-h-screen px-4 py-4 sm:py-8">
            <div class="modal-content bg-white w-full max-w-xl max-h-[90vh] flex flex-col rounded-xl shadow-2xl transform transition-all duration-300 opacity-0 translate-y-4" role="dialog">
                <div class="flex justify-between items-center p-6 bg-red-500 rounded-t-xl flex-shrink-0">
                    <h3 class="text-2xl font-bold text-white">ğŸ”¥ è¨‚å–®è³‡è¨Šæ ¸å° (æœ€å¾Œç¢ºèª)</h3>
                    <button onclick="toggleConfirmationModal(false)" class="text-white hover:text-red-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="flex-grow overflow-y-auto p-6 space-y-4">
                    <div class="p-4 bg-orange-50 border-l-4 border-orange-400 rounded-lg">
                        <h4 class="text-xl font-bold text-orange-700">ç¸½é‡‘é¡: <span id="confirmation-total-amount" class="text-red-600"></span></h4>
                        <p id="confirmation-doc-id" class="text-xs text-gray-500 mt-1"></p>
                    </div>

                    <h4 class="text-lg font-bold text-gray-700 border-b pb-2">å°‡å‚³é€çµ¦åº—å®¶çš„ LINE è¨Šæ¯å…§å®¹:</h4>
                    
                    <!-- è¨Šæ¯å…§å®¹é¡¯ç¤ºå€å¡Š -->
                    <div class="bg-gray-800 text-green-400 p-4 rounded-lg shadow-inner overflow-x-auto">
                        <pre id="confirmation-message-display" class="message-pre"></pre>
                    </div>

                </div>

                <div class="p-6 border-t border-gray-100 flex-shrink-0 space-y-3">
                    <button onclick="sendOrderViaLine()" class="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-150 active:scale-[.99]">
                        âœ… ç¢ºèªç„¡èª¤ï¼Œå‚³é€è‡³ LINE (joe690130)
                    </button>
                    <button onclick="toggleConfirmationModal(false)" class="w-full py-3 bg-gray-200 text-gray-700 font-bold rounded-lg shadow-md hover:bg-gray-300 transition duration-150 active:scale-[.99]">
                        ä¿®æ”¹è¨‚å–®
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- END: Order Confirmation Modal -->

    <!-- Global Notification & Loading -->
    <div id="notification" class="fixed bottom-5 right-5 p-4 rounded-lg shadow-xl text-white opacity-0 hidden z-50"></div>
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-30 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-2xl flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-orange-500"></div>
            <span class="text-gray-700 font-semibold">è¨‚å–®è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</span>
        </div>
    </div>
</body>
</html>
