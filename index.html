<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>珍香小館 - 線上訂餐</title>
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Firebase SDKs for Auth and Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('Debug'); // 取消註釋此行可查看 Firebase 詳細日誌

        // --- 🚨 步驟一：請在這裡貼上您自己的 Firebase 設定 🚨 ---
        // 請務必從您的 Firebase 專案設定中取得以下金鑰。
        const YOUR_FIREBASE_CONFIG = {
            apiKey: null, // <-- 請貼上您的 apiKey (例如: "AIzaSyC...")
            authDomain: null, // <-- 請貼上您的 authDomain (例如: "your-project-id.firebaseapp.com")
            projectId: null, // <-- 請貼上您的 projectId (例如: "your-project-id")
            storageBucket: null,
            messagingSenderId: null,
            appId: null,
            measurementId: null
        };
        // --------------------------------------------------------

        // --- GLOBAL SETUP ---
        window.app = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.isFirebaseReady = false; // 追蹤 Firebase 是否成功初始化
        window.appId = YOUR_FIREBASE_CONFIG.projectId || 'default-github-page-app'; 

        /**
         * Initializes Firebase services and authenticates the user.
         */
        async function initializeFirebase() {
            const cleanConfig = Object.fromEntries(
                Object.entries(YOUR_FIREBASE_CONFIG).filter(([_, v]) => v !== null)
            );
            const hasUserConfig = cleanConfig.apiKey && cleanConfig.projectId;

            if (!hasUserConfig) {
                console.warn("Firebase 設定檔遺失或未填寫。雲端訂單備份功能已停用 (離線模式)。");
                document.getElementById('user-info').textContent = '用戶ID: 離線模式 (請填寫配置)';
                return; 
            }
            
            // --- 正常初始化流程 (使用用戶的配置) ---
            try {
                window.app = initializeApp(cleanConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);
                window.isFirebaseReady = true;

                await signInAnonymously(window.auth);

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.currentUserId = user.uid;
                        document.getElementById('user-info').textContent = '用戶ID: ' + user.uid.substring(0, 8) + '... (雲端連線)';
                    } else {
                        window.currentUserId = null;
                        document.getElementById('user-info').textContent = '用戶ID: 連線失敗';
                    }
                });

            } catch (error) {
                console.error("Firebase 初始化錯誤:", error);
                showNotification('Firebase 初始化失敗，雲端備份無法使用。', 'error');
                window.isFirebaseReady = false;
            }
        }

        // Expose Firebase functions to the global scope
        window.initializeFirebase = initializeFirebase;
        window.addDoc = addDoc;
        window.collection = collection;
        window.serverTimestamp = serverTimestamp;

    </script>
    <style>
        /* Custom font and basic styling */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Custom scrollbar for aesthetic */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #f97316; /* Orange-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #ffeac7; /* Lighter Orange */
        }
    </style>
    <script>
        // --- APP DATA AND STATE ---
        const EXTRA_CHARGE = 10; // 加量費用 NT$10
        
        const menuData = [
            // --- 炒飯類 (Fried Rice) ---
            { id: 'FR1', name: '肉絲炒飯', price: 70, category: '炒飯類', description: '經典肉絲，米粒分明' },
            { id: 'FR2', name: '蝦仁蛋炒飯', price: 80, category: '炒飯類', description: 'Q彈蝦仁，金黃蛋花' },
            { id: 'FR3', name: '香腸蛋炒飯', price: 75, category: '炒飯類', description: '台式香腸，風味獨特' },
            { id: 'FR4', name: '火腿蛋炒飯', price: 75, category: '炒飯類', description: '火腿丁，經典口味' },
            { id: 'FR5', name: '培根蛋炒飯', price: 75, category: '炒飯類', description: '培根香氣，口感豐富' },
            { id: 'FR6', name: '雞肉蛋炒飯', price: 75, category: '炒飯類', description: '鮮嫩雞肉，家常美味' },
            { id: 'FR7', name: '宮保雞丁炒飯', price: 80, category: '炒飯類', description: '微辣宮保醬汁' },
            { id: 'FR8', name: '麻油雞丁蛋炒飯', price: 80, category: '炒飯類', description: '濃郁麻油香，滋補溫暖' },
            { id: 'FR9', name: '青椒肉絲炒飯', price: 80, category: '炒飯類', description: '青椒肉絲，香氣四溢' },
            { id: 'FR10', name: '牛肉蛋炒飯', price: 85, category: '炒飯類', description: '鮮嫩牛肉，風味濃郁' },
            { id: 'FR11', name: '青椒牛肉蛋炒飯', price: 90, category: '炒飯類', description: '青椒牛肉，大份滿足' },

            // --- 蓋飯/燴飯 (Covered Rice / Gravy Rice) ---
            { id: 'CR1', name: '日式豬肉蓋飯', price: 90, category: '蓋飯/燴飯', description: '日式醬汁，滑嫩豬肉' },
            { id: 'CR2', name: '日式雞肉蓋飯', price: 90, category: '蓋飯/燴飯', description: '日式醬汁，鮮嫩雞肉' },
            { id: 'CR3', name: '日式海鮮蓋飯', price: 90, category: '蓋飯/燴飯', description: '日式醬汁，豐富海鮮' },
            { id: 'CR4', name: '日式牛肉蓋飯', price: 90, category: '蓋飯/燴飯', description: '日式醬汁，鮮嫩牛肉' },
            { id: 'CR5', name: '宮保雞丁蓋飯', price: 90, category: '蓋飯/燴飯', description: '微辣宮保醬汁，配飯首選' },
            { id: 'CR6', name: '辣子雞丁蓋飯', price: 90, category: '蓋飯/燴飯', description: '香辣夠味，開胃選擇' },
            { id: 'CR7', name: '三杯雞丁蓋飯', price: 90, category: '蓋飯/燴飯', description: '九層塔香氣，台灣味' },
            { id: 'CR8', name: '麻婆雞丁蓋飯', price: 90, category: '蓋飯/燴飯', description: '麻辣豆腐，濃郁醬汁' },
            { id: 'CR9', name: '紅燒豆腐蓋飯', price: 90, category: '蓋飯/燴飯', description: '經典紅燒，鹹香下飯' },

            // --- 炒麵/烏龍 (Wok-Fried Noodles) ---
            { id: 'N1', name: '肉絲炒麵', price: 70, category: '炒麵/烏龍', description: '經典肉絲，大火快炒' },
            { id: 'N2', name: '海鮮炒麵', price: 75, category: '炒麵/烏龍', description: '新鮮海鮮，口感豐富' },
            { id: 'N3', name: '蝦仁炒麵', price: 75, category: '炒麵/烏龍', description: 'Q彈蝦仁，鮮甜美味' },
            { id: 'N4', name: '蛤仔炒麵', price: 75, category: '炒麵/烏龍', description: '蛤蜊鮮味，清爽湯頭' },
            { id: 'N5', name: '炒烏龍', price: 75, category: '炒麵/烏龍', description: 'Q彈烏龍麵，大火快炒' },
            { id: 'N6', name: '牛肉炒麵', price: 85, category: '炒麵/烏龍', description: '鮮嫩牛肉，香氣濃郁' },
            { id: 'N7', name: '沙茶牛肉炒麵', price: 90, category: '炒麵/烏龍', description: '沙茶風味，濃郁香氣' },
            
            // --- 燴飯/快炒 (Gravy Rice / Wok-Fried Rice Dishes) ---
            { id: 'WR1', name: '宮保雞丁燴飯', price: 75, category: '燴飯/快炒', description: '微辣宮保雞丁燴汁，配飯首選' },
            { id: 'WR2', name: '辣子雞丁燴飯', price: 75, category: '燴飯/快炒', description: '香辣夠味燴汁，開胃下飯' },
            { id: 'WR3', name: '三杯雞丁燴飯', price: 75, category: '燴飯/快炒', description: '九層塔香氣三杯燴汁，台灣味' },
            { id: 'WR4', name: '蔥爆肉絲燴飯', price: 75, category: '燴飯/快炒', description: '蔥爆香氣濃郁，經典燴飯' },
            { id: 'WR5', name: '海鮮什錦燴飯', price: 80, category: '燴飯/快炒', description: '豐富海鮮配料，鮮甜燴汁' },
            { id: 'WR6', name: '蔥爆牛肉燴飯', price: 85, category: '燴飯/快炒', description: '經典蔥爆，鮮嫩牛肉燴飯' },
            { id: 'WR7', name: '麻婆豆腐燴飯', price: 75, category: '燴飯/快炒', description: '麻辣豆腐醬汁，香濃下飯' },
            { id: 'WR8', name: '紅燒豆腐燴飯', price: 75, category: '燴飯/快炒', description: '紅燒豆腐醬汁，鹹香回味' },

            // --- 韓式泡菜類 (Kimchi Dishes) ---
            { id: 'KC1', name: '泡菜豬肉飯', price: 80, category: '韓式泡菜類', description: '酸辣泡菜炒豬肉，附白飯' },
            { id: 'KC2', name: '泡菜蝦仁炒飯', price: 80, category: '韓式泡菜類', description: '酸辣泡菜風味炒飯' },
            { id: 'KC3', name: '泡菜香腸炒飯', price: 80, category: '韓式泡菜類', description: '酸辣泡菜與香腸' },
            { id: 'KC4', name: '泡菜雞肉炒飯', price: 80, category: '韓式泡菜類', description: '酸辣泡菜與雞肉丁' },
            { id: 'KC5', name: '泡菜火腿炒飯', price: 80, category: '韓式泡菜類', description: '酸辣泡菜與火腿' },
            { id: 'KC6', name: '泡菜培根炒飯', price: 80, category: '韓式泡菜類', description: '酸辣泡菜與培根' },
            { id: 'KC7', name: '泡菜牛肉炒飯', price: 90, category: '韓式泡菜類', description: '酸辣泡菜與牛肉' },
            { id: 'KC8', name: '泡菜豬肉炒麵', price: 80, category: '韓式泡菜類', description: '酸辣泡菜炒豬肉麵' },
            { id: 'KC9', name: '泡菜海鮮炒麵', price: 80, category: '韓式泡菜類', description: '酸辣泡菜海鮮炒麵' },
            { id: 'KC10', name: '泡菜炒烏龍麵', price: 80, category: '韓式泡菜類', description: '酸辣泡菜炒烏龍' },

            // --- 鍋燒類 (Noodle in Soup) ---
            { id: 'NS1', name: '鍋燒意麵', price: 80, category: '鍋燒類', description: '經典意麵，豐富配料' },
            { id: 'NS2', name: '鍋燒冬粉', price: 80, category: '鍋燒類', description: '清爽冬粉，暖胃湯頭' },
            { id: 'NS3', name: '鍋燒烏龍麵', price: 80, category: '鍋燒類', description: 'Q彈烏龍麵，鮮美湯頭' },
            { id: 'NS4', name: '味噌烏龍麵', price: 80, category: '鍋燒類', description: '日式味噌湯頭' },
            { id: 'NS5', name: '鍋燒海鮮粥', price: 80, category: '鍋燒類', description: '新鮮海鮮，濃郁粥底' },
            
            // --- 精緻套餐 (Set Meals) ---
            { id: 'SM1', name: '宮保雞丁套餐', price: 260, category: '精緻套餐', description: '附白飯(上限三碗)、三樣配菜及每日推薦湯' },
            { id: 'SM2', name: '三杯雞丁套餐', price: 260, category: '精緻套餐', description: '附白飯(上限三碗)、三樣配菜及每日推薦湯' },
            { id: 'SM3', name: '蔥爆豬套餐', price: 260, category: '精緻套餐', description: '附白飯(上限三碗)、三樣配菜及每日推薦湯' },
            { id: 'SM4', name: '蔥爆牛套餐', price: 270, category: '精緻套餐', description: '附白飯(上限三碗)、三樣配菜及每日推薦湯' },

            // --- 湯類 (Soup) ---
            { id: 'SP1', name: '味噌豆腐湯', price: 20, category: '湯類', description: '日式經典，清淡口味' },
            { id: 'SP2', name: '蛋花湯', price: 25, category: '湯類', description: '滑嫩蛋花，家常好味' },
            { id: 'SP3', name: '貢丸湯', price: 35, category: '湯類', description: '彈牙貢丸，湯頭清甜' },
            { id: 'SP4', name: '魚丸湯', price: 35, category: '湯類', description: '鮮美魚丸，清爽不膩' },
            { id: 'SP5', name: '味噌蛤仔湯', price: 50, category: '湯類', description: '味噌與蛤蜊的結合' },
            { id: 'SP6', name: '蛤仔湯', price: 30, category: '湯類', description: '原味蛤蜊，鮮甜暖胃' },
            { id: 'SP7', name: '鮮美蛤仔湯', price: 50, category: '湯類', description: '新鮮蛤蜊，升級份量或加料' },

            // --- 單點小炒 (Side Dishes) ---
            { id: 'SD1', name: '時令青菜', price: 40, category: '單點/小菜', description: '新鮮時令蔬菜，請依現場時價，暫定40元' },
            { id: 'SD2', name: '白飯', price: 10, category: '單點/小菜', description: '香Q白飯' },
            { id: 'SD3', name: '蔥花蛋', price: 40, category: '單點/小菜', description: '蔥花與蛋的完美結合' },
            { id: 'SD4', name: '九層塔蛋', price: 40, category: '單點/小菜', description: '九層塔香氣十足' },
            { id: 'SD5', name: '菜脯蛋', price: 40, category: '單點/小菜', description: '菜脯丁增加口感' },
            { id: 'SD6', name: '洋蔥炒蛋', price: 60, category: '單點/小菜', description: '洋蔥的甜味與炒蛋' },
            { id: 'SD7', name: '蝦仁烘蛋', price: 70, category: '單點/小菜', description: '蝦仁與厚實烘蛋' },
            { id: 'SD8', name: '麻婆豆腐', price: 70, category: '單點/小菜', description: '單點菜餚，無附飯' },
            { id: 'SD9', name: '紅燒豆腐', price: 75, category: '單點/小菜', description: '單點菜餚，無附飯' },
            { id: 'SD10', name: '青椒肉絲', price: 75, category: '單點/小菜', description: '單點菜餚，無附飯' },
            { id: 'SD11', name: '宮保雞丁', price: 75, category: '單點/小菜', description: '單點菜餚，無附飯' },
            { id: 'SD12', name: '三杯雞丁', price: 75, category: '單點/小菜', description: '單點菜餚，無附飯' },
            { id: 'SD13', name: '辣子雞丁', price: 75, category: '單點/小菜', description: '單點菜餚，無附飯' },
            { id: 'SD14', name: '蔥爆豬', price: 75, category: '單點/小菜', description: '單點菜餚，無附飯' },
            { id: 'SD15', name: '蔥爆雞', price: 75, category: '單點/小菜', description: '單點菜餚，無附飯' },
            { id: 'SD16', name: '泡菜豬肉', price: 80, category: '單點/小菜', description: '單點菜餚，無附飯' },
            { id: 'SD17', name: '蔥爆牛肉', price: 85, category: '單點/小菜', description: '單點菜餚，無附飯' },
            { id: 'SD18', name: '糖醋雞丁', price: 85, category: '單點/小菜', description: '單點菜餚，無附飯' },
            { id: 'SD19', name: '青椒牛肉', price: 90, category: '單點/小菜', description: '單點菜餚，無附飯' },
            { id: 'SD20', name: '泡菜牛肉', price: 90, category: '單點/小菜', description: '單點菜餚，無附飯' },
        ];

        let cart = {}; // { uniqueKey: { item, quantity, isExtra, isSpicy, noGreenOnion, price, uniqueKey } }
        let currentSelectedItem = null; // 當前在 Options Modal 中選擇的項目

        // --- UTILITY FUNCTIONS ---

        /**
         * Displays a temporary notification message in the corner.
         */
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const color = type === 'success' ? 'bg-green-500' : 'bg-red-500';

            notification.textContent = message;
            notification.className = `fixed bottom-5 right-5 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 z-50 ${color}`;
            notification.classList.remove('opacity-0', 'hidden');
            notification.classList.add('opacity-100');

            setTimeout(() => {
                notification.classList.remove('opacity-100');
                notification.classList.add('opacity-0');
                setTimeout(() => notification.classList.add('hidden'), 300);
            }, 3000);
        }

        /**
         * Formats a number to currency string (NTD format).
         */
        function formatCurrency(amount) {
            return '$' + amount.toLocaleString('zh-TW');
        }

        // --- CART & OPTIONS LOGIC ---

        /**
         * Opens the modal to select quantity and options for an item.
         * @param {string} itemId The ID of the item.
         */
        function openItemOptions(itemId) {
            const item = menuData.find(i => i.id === itemId);
            if (!item) return;

            currentSelectedItem = item;

            // Update modal title and details
            document.getElementById('item-modal-title').textContent = item.name;
            document.getElementById('item-modal-price').textContent = formatCurrency(item.price);
            document.getElementById('item-modal-extra-charge').textContent = `(加量費用 ${formatCurrency(EXTRA_CHARGE)})`;
            document.getElementById('item-quantity-input').value = 1;
            
            // Reset all checkboxes
            document.getElementById('item-extra-checkbox').checked = false;
            document.getElementById('item-spicy-checkbox').checked = false;
            document.getElementById('item-no-green-onion-checkbox').checked = false; 


            // Show the modal
            toggleOptionsModal(true);
        }

        /**
         * Finalizes item addition to the cart from the options modal.
         */
        function addItemToCart() {
            if (!currentSelectedItem) return;

            const quantity = parseInt(document.getElementById('item-quantity-input').value, 10);
            const isExtra = document.getElementById('item-extra-checkbox').checked;
            const isSpicy = document.getElementById('item-spicy-checkbox').checked; 
            const noGreenOnion = document.getElementById('item-no-green-onion-checkbox').checked; 

            if (quantity < 1) {
                showNotification('數量至少為 1', 'error');
                return;
            }

            // 更新 uniqueKey 以包含所有選項
            const uniqueKey = `${currentSelectedItem.id}-${isExtra}-${isSpicy}-${noGreenOnion}`;
            const finalPrice = currentSelectedItem.price + (isExtra ? EXTRA_CHARGE : 0);

            if (cart[uniqueKey]) {
                cart[uniqueKey].quantity += quantity;
            } else {
                cart[uniqueKey] = { 
                    id: currentSelectedItem.id,
                    name: currentSelectedItem.name,
                    price: currentSelectedItem.price, // Base price
                    finalPrice: finalPrice, // Price with extra charge
                    quantity: quantity, 
                    isExtra: isExtra,
                    isSpicy: isSpicy,
                    noGreenOnion: noGreenOnion, 
                    uniqueKey: uniqueKey
                };
            }

            // Close modal and update display
            toggleOptionsModal(false);
            updateCartDisplay();
            
            // 構建通知訊息
            let optionsText = isExtra ? '加量' : '一般份量';
            if (isSpicy) optionsText += ', 加辣';
            if (noGreenOnion) optionsText += ', 不加蔥'; 

            showNotification(`${currentSelectedItem.name} (${optionsText}) x${quantity} 已加入購物車`, 'success');
            currentSelectedItem = null;
        }
        
        /**
         * Decrements the quantity of an item or removes it if quantity reaches 0.
         * @param {string} uniqueKey The unique key of the item variation to remove.
         */
        function removeFromCart(uniqueKey) {
            if (cart[uniqueKey]) {
                cart[uniqueKey].quantity -= 1;
                if (cart[uniqueKey].quantity <= 0) {
                    delete cart[uniqueKey];
                }
                updateCartDisplay();
            }
        }

        /**
         * Updates the cart badge count and total in the UI.
         */
        function updateCartDisplay() {
            const cartItems = Object.values(cart);
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            const totalAmount = cartItems.reduce((sum, item) => sum + item.quantity * item.finalPrice, 0);

            document.getElementById('cart-count').textContent = totalItems;
            
            // Update main checkout modal content if it's open (handles all totals)
            renderCartModalContent();
        }

        /**
         * Renders the cart contents inside the modal.
         */
        function renderCartModalContent() {
            const cartList = document.getElementById('cart-list');
            const cartItems = Object.values(cart);

            let html = '';
            const totalAmount = cartItems.reduce((sum, item) => sum + item.quantity * item.finalPrice, 0);
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0); // NEW: Calculate total items
            
            document.getElementById('cart-total-amount').textContent = formatCurrency(totalAmount);
            
            // NEW: Update total items display in the modal
            const cartTotalItemsEl = document.getElementById('cart-total-items');
            if (cartTotalItemsEl) {
                cartTotalItemsEl.textContent = `${totalItems} 份`;
            }


            if (cartItems.length === 0) {
                html = '<p class="text-gray-500 text-center py-8">購物車是空的，快去點餐吧！</p>';
                document.getElementById('checkout-button').disabled = true;
                document.getElementById('checkout-button').classList.add('opacity-50', 'cursor-not-allowed');
                document.getElementById('customer-input-container').classList.add('hidden'); 
            } else {
                document.getElementById('checkout-button').disabled = false;
                document.getElementById('checkout-button').classList.remove('opacity-50', 'cursor-not-allowed');
                document.getElementById('customer-input-container').classList.remove('hidden');

                cartItems.forEach(item => {
                    // 組合所有選項的顯示文字
                    let optionText = item.isExtra ? '<span class="text-red-500 font-medium">加量+$10</span>' : '<span class="text-gray-400 font-normal">一般份量</span>';
                    if (item.isSpicy) {
                        optionText += ' / <span class="text-red-600 font-medium">加辣🌶️</span>';
                    }
                    if (item.noGreenOnion) {
                        optionText += ' / <span class="text-gray-600 font-medium">不加蔥🌿</span>';
                    }

                    const subtotal = item.finalPrice * item.quantity;
                    
                    html += `
                        <div class="flex items-center justify-between p-4 border-b border-orange-100 last:border-b-0">
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-lg text-gray-800 truncate">${item.name}</p>
                                <p class="text-sm text-gray-500">${optionText}</p>
                                <p class="text-orange-500">${formatCurrency(item.finalPrice)} x ${item.quantity} = ${formatCurrency(subtotal)}</p>
                            </div>
                            <div class="flex items-center space-x-2 ml-4">
                                <button onclick="removeFromCart('${item.uniqueKey}')" class="w-8 h-8 flex items-center justify-center bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition duration-150 active:scale-95">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                                <span class="font-bold text-gray-800 w-6 text-center">${item.quantity}</span>
                                <button onclick="openItemOptions('${item.id}')" class="w-8 h-8 flex items-center justify-center bg-orange-100 text-orange-600 rounded-full hover:bg-orange-200 transition duration-150 active:scale-95">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            cartList.innerHTML = html;
        }

        // --- ORDER SUBMISSION AND LINE INTEGRATION ---

        async function submitOrder() {
            // 取得新的訂單類型欄位
            const orderType = document.getElementById('order-type-select').value.trim(); 
            // 希望送達時間改為備註
            const notes = document.getElementById('notes-input').value.trim(); 
            const deliveryInfo = document.getElementById('delivery-info-input').value.trim();
            
            if (Object.keys(cart).length === 0) {
                showNotification('購物車是空的，無法送出訂單', 'error');
                return;
            }
            
            // 驗證新的輸入欄位：訂單類型
            if (!orderType) {
                showNotification('請選擇訂單類型 (自取/外送)！', 'error');
                document.getElementById('order-type-select').focus();
                return;
            }

            // 驗證原本必填的輸入欄位
            if (!deliveryInfo) {
                showNotification('請輸入公司/電話/地址 (必填欄位)！', 'error');
                document.getElementById('delivery-info-input').focus();
                return;
            }


            const totalAmount = Object.values(cart).reduce((sum, item) => sum + item.quantity * item.finalPrice, 0);
            const totalItems = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
            let docRefId = 'N/A (離線模式)';

            document.getElementById('loading-overlay').classList.remove('hidden');

            if (window.isFirebaseReady && window.db && window.currentUserId) {
                const orderData = {
                    userId: window.currentUserId,
                    appId: window.appId,
                    orderType: orderType, // 新增欄位
                    deliveryInfo: deliveryInfo, 
                    notes: notes, // 更新為備註
                    items: Object.values(cart).map(item => ({
                        id: item.id,
                        name: item.name,
                        option: `${item.isExtra ? '加量' : '一般'}${item.isSpicy ? '/加辣' : ''}${item.noGreenOnion ? '/不加蔥' : ''}`, 
                        isExtra: item.isExtra,
                        isSpicy: item.isSpicy,
                        noGreenOnion: item.noGreenOnion, 
                        basePrice: item.price,
                        finalPrice: item.finalPrice,
                        quantity: item.quantity,
                        subtotal: item.finalPrice * item.quantity
                    })),
                    totalAmount: totalAmount,
                    totalItems: totalItems, // 新增：合計數量
                    status: 'Pending',
                    createdAt: window.serverTimestamp()
                };

                const path = `artifacts/${window.appId}/users/${window.currentUserId}/orders`;

                try {
                    const docRef = await window.addDoc(window.collection(window.db, path), orderData);
                    docRefId = docRef.id;
                    showNotification(`訂單已備份至雲端 (ID: ${docRefId})`, 'success');
                } catch (e) {
                    console.error("Error adding document: ", e);
                    showNotification(`雲端備份失敗：${e.message}。訂單將透過 LINE 傳送。`, 'error');
                }
            } else {
                 showNotification(`雲端備份已跳過 (離線模式)。`, 'error');
            }

            // 更新 LINE 訊息格式
            let messageText = `【珍香小館 - 新訂單】\n`;
            messageText += `==========================\n`;
            messageText += `🛍️ 訂單類型: ${orderType}\n`; // 訂單類型
            messageText += `📍 客戶/外送資訊: ${deliveryInfo}\n`;
            messageText += `📝 備註 (送達/要求): ${notes || '無'}\n`; // 備註
            messageText += `--------------------------\n`;
            messageText += `💰 總金額: ${formatCurrency(totalAmount)}\n`;
            messageText += `🔢 合計數量: ${totalItems} 份\n`; // NEW: 合計數量
            messageText += `📜 訂單詳情:\n`;

            Object.values(cart).forEach(item => {
                let optionText = item.isExtra ? ' (加量+$10)' : '';
                if (item.isSpicy) optionText += ' (加辣)';
                if (item.noGreenOnion) optionText += ' (不加蔥)'; 

                messageText += ` > ${item.name}${optionText} x ${item.quantity} (${formatCurrency(item.finalPrice * item.quantity)})\n`;
            });

            messageText += `--------------------------\n`;
            messageText += `(參考ID: ${docRefId}) 請傳送給 LINE ID: joe690130`;

            const lineMessage = encodeURIComponent(messageText);
            const lineUrl = `https://line.me/R/share?text=${lineMessage}`;

            // 重置輸入欄位和購物車
            document.getElementById('delivery-info-input').value = ''; 
            document.getElementById('notes-input').value = ''; 
            document.getElementById('order-type-select').value = ''; 
            cart = {};
            updateCartDisplay();
            toggleCartModal(false);

            document.getElementById('loading-overlay').classList.add('hidden');
            showNotification(`請切換至 LINE 視窗手動傳送訊息給 joe690130 完成通知！`, 'success');
            
            // 跳轉至 LINE
            window.open(lineUrl, '_blank');
        }

        // --- UI RENDERING ---
        function renderMenu() {
            const menuContainer = document.getElementById('menu-container');
            const categoryOrder = [
                '炒飯類', '蓋飯/燴飯', '炒麵/烏龍', '燴飯/快炒', '韓式泡菜類', 
                '鍋燒類', '精緻套餐', '單點/小菜', '湯類'
            ];
            const categories = categoryOrder.filter(c => menuData.some(item => item.category === c));
            let html = '';

            categories.forEach(category => {
                const items = menuData.filter(item => item.category === category);
                html += `
                    <div id="${category}" class="mt-8">
                        <!-- 類別標題設計 - 字體放大, 加上橘色底色, 圓角與陰影 -->
                        <h2 class="text-3xl sm:text-4xl font-extrabold text-orange-800 mb-6 bg-orange-200 p-4 rounded-xl shadow-md tracking-tight">
                            ${category}
                        </h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                `;
                items.forEach(item => {
                    html += `
                        <div class="bg-white rounded-xl p-4 shadow-md hover:shadow-lg transition duration-200 flex flex-col justify-between">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-1">${item.name}</h3>
                                <p class="text-sm text-gray-500 mb-3">${item.description}</p>
                            </div>
                            <div class="flex justify-between items-center mt-2 border-t pt-2">
                                <span class="text-2xl font-extrabold text-orange-600">${formatCurrency(item.price)}</span>
                                <button onclick="openItemOptions('${item.id}')"
                                    class="px-4 py-2 bg-orange-500 text-white font-semibold rounded-full shadow-md hover:bg-orange-600 transition duration-150 active:scale-95 flex items-center space-x-1 text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                    </svg>
                                    <span>點餐/選量</span>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div></div>';
            });
            menuContainer.innerHTML = html;
        }

        function toggleCartModal(show) {
            const modal = document.getElementById('cart-modal');
            if (show) {
                renderCartModalContent();
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.querySelector('.modal-content').classList.remove('opacity-0', 'translate-y-4');
                    modal.classList.add('bg-black', 'bg-opacity-50');
                }, 10);
            } else {
                modal.querySelector('.modal-content').classList.add('opacity-0', 'translate-y-4');
                modal.classList.remove('bg-black', 'bg-opacity-50');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }
        
        function toggleOptionsModal(show) {
            const modal = document.getElementById('item-options-modal');
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => { 
                    modal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
                    modal.classList.add('bg-black', 'bg-opacity-50');
                }, 10);
            } else {
                modal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
                modal.classList.remove('bg-black', 'bg-opacity-50');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        // --- INITIALIZATION ---
        window.onload = async () => {
            await window.initializeFirebase();
            renderMenu(); 
            updateCartDisplay();
        };

        // Expose functions globally
        window.openItemOptions = openItemOptions;
        window.addItemToCart = addItemToCart;
        window.removeFromCart = removeFromCart;
        window.toggleCartModal = toggleCartModal;
        window.toggleOptionsModal = toggleOptionsModal;
        window.submitOrder = submitOrder;
    </script>
</head>
<body class="min-h-screen">

    <!-- Header & Navigation -->
    <header class="sticky top-0 bg-white shadow-lg z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-orange-600 tracking-tight">
                珍香小館
                <span class="text-sm text-gray-500 font-normal block">線上點餐服務</span>
            </h1>
            <div class="flex items-center space-x-4">
                <span id="user-info" class="text-xs text-gray-500 hidden sm:block">載入用戶中...</span>
                <button onclick="toggleCartModal(true)" class="relative p-3 bg-orange-500 rounded-full text-white shadow-xl hover:bg-orange-600 transition duration-150 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span id="cart-count" class="absolute -top-1 -right-1 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform bg-red-600 rounded-full">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content: Menu -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <p class="text-lg text-gray-600 mb-6 border-b pb-4">
            請點選您想點的品項。點餐時可選擇 **加量 (+$${EXTRA_CHARGE})**、**加辣**、**不加蔥** 等選項。
        </p>
        <div id="menu-container">
            <div class="text-center py-20 text-gray-500">
                <p>菜單載入中...</p>
                <div class="mt-4 animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mx-auto"></div>
            </div>
        </div>
    </main>
    
    <!-- Item Options Modal -->
    <div id="item-options-modal" class="fixed inset-0 hidden z-50 transition-all duration-300" onclick="if(event.target.id === 'item-options-modal') toggleOptionsModal(false)">
        <div class="flex items-center justify-center min-h-screen px-4 py-8">
            <div class="modal-content bg-white w-full max-w-sm rounded-xl shadow-2xl transform transition-all duration-300 opacity-0 scale-95" role="dialog">
                <div class="flex justify-between items-center p-4 bg-orange-500 rounded-t-xl">
                    <h3 id="item-modal-title" class="text-xl font-bold text-white">品項名稱</h3>
                    <button onclick="toggleOptionsModal(false)" class="text-white hover:text-orange-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="text-lg font-semibold text-gray-700">
                        單價: <span id="item-modal-price" class="text-orange-600"></span>
                    </div>
                    <div>
                        <label for="item-quantity-input" class="block text-sm font-medium text-gray-700 mb-1">選擇數量</label>
                        <input type="number" id="item-quantity-input" value="1" min="1" max="99" class="w-full p-3 border border-gray-300 rounded-lg text-center focus:ring-orange-500 focus:border-orange-500" />
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <label for="item-extra-checkbox" class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="item-extra-checkbox" class="h-5 w-5 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                            <span class="text-base font-semibold text-gray-800">是否加量</span>
                        </label>
                        <span id="item-modal-extra-charge" class="text-red-500 font-bold text-sm">(加量費用 $10)</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <label for="item-spicy-checkbox" class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="item-spicy-checkbox" class="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <span class="text-base font-semibold text-gray-800">是否加辣 🌶️</span>
                        </label>
                        <span class="text-gray-500 font-bold text-sm">(不加價)</span>
                    </div>
                    <!-- 修正：蔥花選項文字 -->
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <label for="item-no-green-onion-checkbox" class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" id="item-no-green-onion-checkbox" class="h-5 w-5 text-gray-600 border-gray-300 rounded focus:ring-gray-500">
                            <span class="text-base font-semibold text-gray-800">是否不加蔥 🌿</span>
                        </label>
                        <span class="text-gray-500 font-bold text-sm">(不加價)</span>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-100">
                    <button onclick="addItemToCart()" class="w-full py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition duration-150 active:scale-[.99]">
                        加入購物車
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Modal (Checkout Pop-up) -->
    <div id="cart-modal" class="fixed inset-0 hidden z-40 transition-all duration-300" onclick="if(event.target.id === 'cart-modal') toggleCartModal(false)">
        <div class="flex items-center justify-center min-h-screen px-4 py-4 sm:py-8">
            <div class="modal-content bg-white w-full max-w-lg max-h-[90vh] flex flex-col rounded-xl shadow-2xl transform transition-all duration-300 opacity-0 translate-y-4" role="dialog">
                <div class="flex justify-between items-center p-6 bg-orange-500 rounded-t-xl flex-shrink-0">
                    <h3 id="modal-title" class="text-2xl font-bold text-white">您的訂單</h3>
                    <button onclick="toggleCartModal(false)" class="text-white hover:text-orange-100 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 pb-4 border-b border-gray-100 flex-shrink-0">
                    <!-- UPDATED: 顯示總計金額和合計數量 -->
                    <div class="space-y-2 mb-4">
                        <div class="flex justify-between items-center text-2xl font-bold">
                            <span>總計金額:</span>
                            <span id="cart-total-amount" class="text-orange-600">$0</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-semibold text-gray-700 border-t pt-2">
                            <span>合計數量:</span>
                            <span id="cart-total-items" class="text-gray-900 font-extrabold">0 份</span>
                        </div>
                    </div>
                    <!-- END UPDATED BLOCK -->
                    <button id="checkout-button" onclick="submitOrder()" class="w-full py-3 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition duration-150 active:scale-[.99] disabled:opacity-50 disabled:cursor-not-allowed">
                        送出訂單 & 通知 LINE ID: joe690130
                    </button>
                    <p class="text-center text-sm text-gray-500 mt-2 mb-4">
                        **送出後將跳出 LINE 視窗，請點擊傳送給 joe690130 完成通知**
                    </p>
                    <!-- 客戶資訊輸入欄位 -->
                    <div id="customer-input-container" class="space-y-3 border-t pt-4 hidden">
                        <!-- 新增：自取/外送選項 -->
                        <select id="order-type-select" required class="w-full p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition">
                            <option value="">-- 請選擇訂單類型 (必填) --</option>
                            <option value="外送">外送 (Delivery)</option>
                            <option value="自取">自取 (Pickup)</option>
                        </select>
                        <input type="text" id="delivery-info-input" placeholder="輸入公司/電話/地址 (必填)" required class="w-full p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" />
                        <!-- 修正：希望送達時間改為備註 -->
                        <textarea id="notes-input" placeholder="備註 (例: 送達時間, 特殊要求)" class="w-full p-3 border border-orange-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition h-20 resize-none"></textarea>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto">
                    <div id="cart-list" class="divide-y divide-gray-100">
                        <!-- Cart items rendered here by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Notification & Loading -->
    <div id="notification" class="fixed bottom-5 right-5 p-4 rounded-lg shadow-xl text-white opacity-0 hidden z-50"></div>
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-30 z-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-2xl flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-orange-500"></div>
            <span class="text-gray-700 font-semibold">訂單處理中，請稍候...</span>
        </div>
    </div>
</body>
</html>
